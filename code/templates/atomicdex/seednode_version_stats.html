{% extends "base.html" %}
{% load static %}
{% block content %}
{% load mathfilters %}
	<div class="row col-12 mx-auto my-2" style="color: #b9b5b5;">
		<div class="card col-12 m-0 p-0">
			<div class="card-header flex">
				<h2>{{ season_clean }} MM2 Version Status (last 24hrs)</h2>
				From <input class="dt_picker" type="text" id="start" value="" /> 
				to <input class="dt_picker" type="text" id="end" value="" />


			</div>
			<div class="card-body flex">
				<div class="graph_container" style="height:1300px;">
					<canvas id="myChart"></canvas>
				</div>
			</div>
			<div class="card-footer flex">
				<h6><i></i></h6>
			</div>
		</div>
	</div>

  	<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	
	<script>

function getOffset() {
	var d = new Date();
	return d.getTimezoneOffset()*60*1000;
}

function local_date_str(date_str) {
  var d = Date.parse(date_str);
  var offset = getOffset()
  var x = new Date(d-offset)
  var ds = x.toLocaleDateString();
  var ts = x.toLocaleTimeString();
  return ds+" "+ts;
}

function get_versionData(url) {

    $.getJSON( url, {
      format: "json",
    })
    .done(function(data) {
		console.log(">>> version data updated")
		let notary_colors = data.chart_data.colors_dict
		for (notary in notary_colors) {
			notary_colors[notary] = notary_colors[notary].reverse()
		}
		let hour_labels = data.chart_data.hours_list.reverse()

		let local_hour_labels = []

		
	    for (i in hour_labels) {
	    	local_hour_labels[i] = local_date_str(hour_labels[i])
	    	console.log(local_hour_labels[i])
	    	if (local_hour_labels[i].split(" ")[1] == "00:00:00") {
	    		local_hour_labels[i] = local_hour_labels[i].split(" ")[0]
	    	} else {
	    		local_hour_labels[i] = local_hour_labels[i].split(" ")[1].substring(0, 5)
	    	}
		}

			data_1 = [
					1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
					1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
					1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
					1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
					1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
					1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
					1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
					1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
					1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
					1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
					1, 1, 1, 1
			    ]
			data_0 = [
					0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					0, 0, 0, 0
			    ]

		var datasets = []
		var notary_labels = []
		for (let i = 0; i < local_hour_labels.length; i++) {
			let backgroundColor = []
			let j = 0
			for (notary in notary_colors) {
				if (i == 0) {
					notary_labels[j] = notary
				}
				color = notary_colors[notary][i]
				backgroundColor[j] = color;
				j++;
			}
			datasets[i] = {
			axis: 'y',
			data: _data = ((i == 0) ? data_0 : data_1),
			backgroundColor: backgroundColor,
			fill: false,
			  borderColor: backgroundColor,
			  borderWidth: 0,
		      borderRadius: 10
			}
		}
		const config = {
		  type: 'horizontalBar',
		  data : {
			  labels: notary_labels,
			  datasets: datasets,
			},
		  options: {
            maintainAspectRatio: false,
        	legend: {
		  		display: false
		  	},
	        tooltips: {
	            callbacks: {
	                label: function(tooltipItem, data) {
	                    var label = local_hour_labels[tooltipItem.datasetIndex]
	                    return label;
	                }
	            }
	        },
			scales: {
				xAxes: [
					{
						position: 'top',
		                type: 'category',
		                labels: local_hour_labels,
						gridLines: {
							display: true,
							drawBorder: false,
			                offsetGridLines: true,
			                color: '#33333300'
						},
						stacked: true,
						ticks: {
		                    autoSkip: false,
		                    maxRotation: 90,
		                    minRotation: 90,
							display: true,
							beginAtZero: true,
							fontFamily: "Helvetica, sans-serif",
							fontSize: 13,
		                    min: 0,
		                    max: 24
						},

					},
					{
						position: 'bottom',
		                type: 'category',
		                labels: local_hour_labels,
						gridLines: {
							display: true,
							drawBorder: false,
			                color: '#33333399'
						},
						scaleLabel: {
							display: false
						},
						stacked: true,
						ticks: {
		                    autoSkip: false,
		                    maxRotation: 90,
		                    minRotation: 90,
							display: true,
							beginAtZero: true,
							fontFamily: "Helvetica, sans-serif",
							fontSize: 13,
		                    min: 0,
		                    max: 25
						},
					}
				],
				yAxes: [
					{
						gridLines: {
							display: true,
							drawBorder: false
						},
						scaleLabel: {
							display: false
						},
						stacked: true,
						ticks: {
		                    autoSkip: false,
							display: true,
							fontFamily: "Helvetica, sans-serif",
							fontSize: 14
						}
					}
				]
			},
		  }
		};
		var ctx = document.getElementById("myChart");
		myChart = new Chart(ctx, config);
    })
}

{% autoescape off %}
url = "/api/mm2/version_stats_by_hour/?chart=1&start={{start}}&end={{end}}"

$('#start').val(local_date_str('{{start_str}}'))
$('#end').val(local_date_str('{{end_str}}'))
{% endautoescape %}

var myChart;
get_versionData(url)


function update_chart() {
    var start = Date.parse($('#start').datetimepicker('getValue'))/1000;
    var end = Date.parse($('#end').datetimepicker('getValue'))/1000;
    myChart.destroy()
	console.log(start)
	console.log(end)
	url = "/api/mm2/version_stats_by_hour/?chart=1&start="+start+"&end="+end
	get_versionData(url)
}

$('#start').on('change', function () {
    update_chart()
});
$('#end').on('change', function () {
    update_chart()
});

	</script>
{% endblock %}
